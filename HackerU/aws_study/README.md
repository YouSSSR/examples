# Самостоятельная работа
## Автоматизация создания станции на AWS 

Первоначально, создаем директорию, в которой создаем файлы и папки необходимые для работы.

### Папки
files - для файлов. В нем размещаем публичный ssh ключ
group_vars - для переменных

### Файлы
id_rsa.pub - открытый ключ SSH. Его копируют на сервера, куда нужно получить доступ.
all.yaml - в папке group_vars. Содержит перечень переменных и их значения, которыми в дальнейшем будет пользоваться автоматизация.
.gitignore - папка, для перечня файлов, которые не надо выкладывать в гит. Для файла vault с ключем. Т.к. исходный код 
ключа должен храниться отдельно (в учебных целях я помещаю его здесь же, но игнорю в гите)
env.ssh - автоматизация от преподавателя. Для переменной ANSIBLE_VAULT_PASSWORD_FILE задаем указатель на расположение файла vault.
hosts - для хостов, которые мы будем подымать в облаке в группе [nginx]. Хосты  nginx-1 и  nginx-2
main.yaml - собственно это исполняемый файл автоматизации. О нем ниже.
requirements.yaml - файл, содержит все зависимости питоновского приложения для работы с AWS. В нашем случае это библиотека boto,
которую можно установить командой pip install -r requirements.yaml.
vault - здесь храниться секрет, которым мы будем шифровать ключи, чтобы завести все это в гит и хранить все в гите безбоязнено.
Пароли хранить в гите не надо! Записываем в него произвольный набор символов.

## main.yaml
Чтобы создать и запустить машину на AWS необходимо, чтобы у нас были определены все значения ключей из таска Launch instance.

###1. Шифруем ключи от AWS
Используя команду `ansible-vault encrypt_string НАША СТРОКА` шифруем ключи, которые мы получили от AWS и помещаем их в all,
в переменные ec2_access_key и ec2_secret_key. 
Чтобы проверить, что расшифровка происходит, используем `debug: var=ec2_access_key`

###2. Создаем ключ доступа для сервера используя id_rsa.pub
Ключ создаем один раз, т.к. на обоих серверах он будет одинаков.
Все работы выполняем на локальной машине, поскольку физически наши сервера еще не созданы, а конфигурацию для них нужно 
где-то создавать. После того, как мы создадим конфигурацию, мы просто ее передаем в облако и создаем машину.
`key_material` будет браться из файла, id_rsa.pub, котррый у нас уже есть.

Далее, нужно создать секюрити группу для таска Launch instance. Чтобы ее создать, нужно создать vpc и subnet.

###3. Создаем vpc - группу нетворков, сеть, в которой будут работать наши машины.
Ее мы также создаем однократно (две сети для одной задачи не нужно).
Здесь `cidr_block` - это сеть, которую мы задаем, и которую мы будем дробить на подсети.

###4. Создаем subnet подсеть для каждого сервера.
`vpc_id` -ключ, который мы берем из созданной переменной vpc предыдущего таска.

###5. Создаем политику доступа в наш subnet.
Здесь в `rules` мы задаем правила для входящего и исходящего трафика.

###6. Создаем и запускаем машины.
###7. Создаем новую динамическую группу для серверов.
В этой группе мы разместим наши сервера.
###8. Создаем таск ожидания и подключения серверов по SSH.
###9. Создаем дополнительные таски.
Уже в группе realservers, на наших реальных серверах, мы выполняем те задачи, для которых мы и подымали эти сервера.





